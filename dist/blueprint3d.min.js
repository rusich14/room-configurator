var BP3D;!function(a){var b;!function(a){var b=function(){function a(){}return a.pointDistanceFromLine=function(b,c,d,e,f,g){var h=a.closestPointOnLine(b,c,d,e,f,g),i=b-h.x,j=c-h.y;return Math.sqrt(i*i+j*j)},a.closestPointOnLine=function(a,b,c,d,e,f){var g,h,i=a-c,j=b-d,k=e-c,l=f-d,m=i*k+j*l,n=k*k+l*l,o=m/n;return o<0||c==e&&d==f?(g=c,h=d):o>1?(g=e,h=f):(g=c+o*k,h=d+o*l),{x:g,y:h}},a.distance=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},a.angle=function(a,b,c,d){var e=a*c+b*d,f=a*d-b*c,g=-Math.atan2(f,e);return g},a.angle2pi=function(b,c,d,e){var f=a.angle(b,c,d,e);return f<0&&(f+=2*Math.PI),f},a.isClockwise=function(b){for(var c=Math.min(0,Math.min.apply(null,a.map(b,function(a){return a.x}))),d=Math.min(0,Math.min.apply(null,a.map(b,function(a){return a.x}))),e=a.map(b,function(a){return{x:a.x-c,y:a.y-d}}),f=0,g=0;g<e.length;g++){var h,i=e[g];h=g==e.length-1?e[0]:e[g+1],f+=(h.x-i.x)*(h.y+i.y)}return f>=0},a.guid=function(){var a=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},a.polygonPolygonIntersect=function(b,c){for(var d=0;d<b.length;d++){var e,f=b[d];if(e=d==b.length-1?b[0]:b[d+1],a.linePolygonIntersect(f.x,f.y,e.x,e.y,c))return!0}return!1},a.linePolygonIntersect=function(b,c,d,e,f){for(var g=0;g<f.length;g++){var h,i=f[g];if(h=g==f.length-1?f[0]:f[g+1],a.lineLineIntersect(b,c,d,e,i.x,i.y,h.x,h.y))return!0}return!1},a.lineLineIntersect=function(a,b,c,d,e,f,g,h){function i(a,b,c){var d=a.x,e=a.y,f=b.x,g=b.y,h=c.x,i=c.y;return(i-e)*(f-d)>(g-e)*(h-d)}var j={x:a,y:b},k={x:c,y:d},l={x:e,y:f},m={x:g,y:h};return i(j,l,m)!=i(k,l,m)&&i(j,k,l)!=i(j,k,m)},a.pointInPolygon=function(b,c,d,e,f){e=e||0,f=f||0;var g=0,h=0;if(void 0===e||void 0===f){for(var i=0;i<d.length;i++)g=Math.min(g,d[i].x),h=Math.min(g,d[i].y);e=g-10,f=h-10}for(var j=0,i=0;i<d.length;i++){var k,l=d[i];k=i==d.length-1?d[0]:d[i+1],a.lineLineIntersect(e,f,b,c,l.x,l.y,k.x,k.y)&&j++}return j%2==1},a.polygonInsidePolygon=function(b,c,d,e){d=d||0,e=e||0;for(var f=0;f<b.length;f++)if(!a.pointInPolygon(b[f].x,b[f].y,c,d,e))return!1;return!0},a.polygonOutsidePolygon=function(b,c,d,e){d=d||0,e=e||0;for(var f=0;f<b.length;f++)if(a.pointInPolygon(b[f].x,b[f].y,c,d,e))return!1;return!0},a.forEach=function(a,b){for(var c=0;c<a.length;c++)b(a[c])},a.forEachIndexed=function(a,b){for(var c=0;c<a.length;c++)b(c,a[c])},a.map=function(a,b){var c=[];return a.forEach(function(a){c.push(b(a))}),c},a.removeIf=function(a,b){var c=[];return a.forEach(function(a){b(a)||c.push(a)}),c},a.cycle=function(a,b){for(var c=a.slice(0),d=0;d<b;d++){var e=c.shift();c.push(e)}return c},a.unique=function(a,b){for(var c=[],d={},e=0;e<a.length;e++)d.hasOwnProperty(a[e])||(c.push(a[e]),d[b(a[e])]=!0);return c},a.removeValue=function(a,b){for(var c=a.length-1;c>=0;c--)a[c]===b&&a.splice(c,1)},a.subtract=function(b,c){return a.removeIf(b,function(b){return a.hasValue(c,b)})},a.hasValue=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1},a}();a.Utils=b}(b=a.Core||(a.Core={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.dimInch="inch",a.dimMeter="m",a.dimCentiMeter="cm",a.dimMilliMeter="mm";var b=function(){function b(){}return b.cmToMeasure=function(b){switch(a.Configuration.getStringValue(a.configDimUnit)){case a.dimInch:var c=.3937*b/12,d=Math.floor(c),e=Math.round(12*(c-d));return d+"'"+e+'"';case a.dimMilliMeter:return""+Math.round(10*b)+" mm";case a.dimCentiMeter:return""+Math.round(10*b)/10+" cm";case a.dimMeter:default:return""+Math.round(10*b)/1e3+" m"}},b}();a.Dimensioning=b}(b=a.Core||(a.Core={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.configDimUnit="dimUnit",a.configWallHeight="wallHeight",a.configWallThickness="wallThickness";var b=function(){function b(){}return b.setValue=function(a,b){this.data[a]=b},b.getStringValue=function(b){switch(b){case a.configDimUnit:return this.data[b];default:throw new Error("Invalid string configuration parameter: "+b)}},b.getNumericValue=function(b){switch(b){case a.configWallHeight:case a.configWallThickness:return this.data[b];default:throw new Error("Invalid numeric configuration parameter: "+b)}},b.data={dimUnit:a.dimInch,wallHeight:250,wallThickness:10},b}();a.Configuration=b}(b=a.Core||(a.Core={}))}(BP3D||(BP3D={}));var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},BP3D;!function(a){var b;!function(b){var c=function(b){function c(a,c,d,e,f,g,h){b.call(this),this.model=a,this.metadata=c,this.errorGlow=new THREE.Mesh,this.hover=!1,this.selected=!1,this.highlighted=!1,this.error=!1,this.emissiveColor=4473924,this.errorColor=16711680,this.obstructFloorMoves=!0,this.allowRotate=!0,this.fixed=!1,this.dragOffset=new THREE.Vector3,this.getHeight=function(){return 2*this.halfSize.y},this.getWidth=function(){return 2*this.halfSize.x},this.getDepth=function(){return 2*this.halfSize.z},this.initObject=function(){this.placeInRoom(),this.scene.needsUpdate=!0},this.scene=this.model.scene,this.geometry=d,this.material=e,this.errorColor=16711680,this.resizable=c.resizable,this.castShadow=!0,this.receiveShadow=!1,this.geometry=d,this.material=e,f?(this.position.copy(f),this.position_set=!0):this.position_set=!1,this.geometry.computeBoundingBox(),this.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(-.5*(this.geometry.boundingBox.max.x+this.geometry.boundingBox.min.x),-.5*(this.geometry.boundingBox.max.y+this.geometry.boundingBox.min.y),-.5*(this.geometry.boundingBox.max.z+this.geometry.boundingBox.min.z))),this.geometry.computeBoundingBox(),this.halfSize=this.objectHalfSize(),g&&(this.rotation.y=g),null!=h&&this.setScale(h.x,h.y,h.z)}return __extends(c,b),c.prototype.remove=function(){this.scene.removeItem(this)},c.prototype.resize=function(a,b,c){var d=b/this.getWidth(),e=a/this.getHeight(),f=c/this.getDepth();this.setScale(d,e,f)},c.prototype.setScale=function(a,b,c){var d=new THREE.Vector3(a,b,c);this.halfSize.multiply(d),d.multiply(this.scale),this.scale.set(d.x,d.y,d.z),this.resized(),this.scene.needsUpdate=!0},c.prototype.setFixed=function(a){this.fixed=a},c.prototype.removed=function(){},c.prototype.updateHighlight=function(){var a=this.hover||this.selected;this.highlighted=a;var b=a?this.emissiveColor:0;this.material.materials.forEach(function(a){a.emissive.setHex(b)})},c.prototype.mouseOver=function(){this.hover=!0,this.updateHighlight()},c.prototype.mouseOff=function(){this.hover=!1,this.updateHighlight()},c.prototype.setSelected=function(){this.selected=!0,this.updateHighlight()},c.prototype.setUnselected=function(){this.selected=!1,this.updateHighlight()},c.prototype.clickPressed=function(a){this.dragOffset.copy(a.point).sub(this.position)},c.prototype.clickDragged=function(a){a&&this.moveToPosition(a.point.sub(this.dragOffset),a)},c.prototype.rotate=function(b){if(b){for(var c=a.Core.Utils.angle(0,1,b.point.x-this.position.x,b.point.z-this.position.z),d=Math.PI/16,e=-4;e<=4;e++)if(Math.abs(c-e*(Math.PI/2))<d){c=e*(Math.PI/2);break}this.rotation.y=c}},c.prototype.moveToPosition=function(a,b){this.position.copy(a)},c.prototype.clickReleased=function(){this.error&&this.hideError()},c.prototype.customIntersectionPlanes=function(){return[]},c.prototype.getCorners=function(a,b,c){c=c||this.position;var d=this.halfSize.clone(),e=new THREE.Vector3((-d.x),0,(-d.z)),f=new THREE.Vector3(d.x,0,(-d.z)),g=new THREE.Vector3(d.x,0,d.z),h=new THREE.Vector3((-d.x),0,d.z),i=new THREE.Matrix4;i.makeRotationY(this.rotation.y),e.applyMatrix4(i),f.applyMatrix4(i),g.applyMatrix4(i),h.applyMatrix4(i),e.add(c),f.add(c),g.add(c),h.add(c);var j=[{x:e.x,y:e.z},{x:f.x,y:f.z},{x:g.x,y:g.z},{x:h.x,y:h.z}];return j},c.prototype.showError=function(a){a=a||this.position,this.error||(this.error=!0,this.errorGlow=this.createGlow(this.errorColor,.8,!0),this.scene.add(this.errorGlow)),this.errorGlow.position.copy(a)},c.prototype.hideError=function(){this.error&&(this.error=!1,this.scene.remove(this.errorGlow))},c.prototype.objectHalfSize=function(){var a=new THREE.Box3;return a.setFromObject(this),a.max.clone().sub(a.min).divideScalar(2)},c.prototype.createGlow=function(a,b,c){c=c||!1,b=b||.2;var d=new THREE.MeshBasicMaterial({color:a,blending:THREE.AdditiveBlending,opacity:.2,transparent:!0,depthTest:!c}),e=new THREE.Mesh(this.geometry.clone(),d);return e.position.copy(this.position),e.rotation.copy(this.rotation),e.scale.copy(this.scale),e},c}(THREE.Mesh);b.Item=c}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=20,d=function(){function b(b,c,d,e){this.floorplan=b,this.x=c,this.y=d,this.id=e,this.wallStarts=[],this.wallEnds=[],this.moved_callbacks=$.Callbacks(),this.deleted_callbacks=$.Callbacks(),this.action_callbacks=$.Callbacks(),this.id=e||a.Core.Utils.guid()}return b.prototype.fireOnMove=function(a){this.moved_callbacks.add(a)},b.prototype.fireOnDelete=function(a){this.deleted_callbacks.add(a)},b.prototype.fireOnAction=function(a){this.action_callbacks.add(a)},b.prototype.getX=function(){return this.x},b.prototype.getY=function(){return this.y},b.prototype.snapToAxis=function(a){var b={x:!1,y:!1},c=this;return this.adjacentCorners().forEach(function(d){Math.abs(d.x-c.x)<a&&(c.x=d.x,b.x=!0),Math.abs(d.y-c.y)<a&&(c.y=d.y,b.y=!0)}),b},b.prototype.relativeMove=function(a,b){this.move(this.x+a,this.y+b)},b.prototype.fireAction=function(a){this.action_callbacks.fire(a)},b.prototype.remove=function(){this.deleted_callbacks.fire(this)},b.prototype.removeAll=function(){for(var a=0;a<this.wallStarts.length;a++)this.wallStarts[a].remove();for(var a=0;a<this.wallEnds.length;a++)this.wallEnds[a].remove();this.remove()},b.prototype.move=function(a,b){this.x=a,this.y=b,this.mergeWithIntersected(),this.moved_callbacks.fire(this.x,this.y),this.wallStarts.forEach(function(a){a.fireMoved()}),this.wallEnds.forEach(function(a){a.fireMoved()})},b.prototype.adjacentCorners=function(){for(var a=[],b=0;b<this.wallStarts.length;b++)a.push(this.wallStarts[b].getEnd());for(var b=0;b<this.wallEnds.length;b++)a.push(this.wallEnds[b].getStart());return a},b.prototype.isWallConnected=function(a){for(var b=0;b<this.wallStarts.length;b++)if(this.wallStarts[b]==a)return!0;for(var b=0;b<this.wallEnds.length;b++)if(this.wallEnds[b]==a)return!0;return!1},b.prototype.distanceFrom=function(b,c){var d=a.Core.Utils.distance(b,c,this.x,this.y);return d},b.prototype.distanceFromWall=function(a){return a.distanceFrom(this.x,this.y)},b.prototype.distanceFromCorner=function(a){return this.distanceFrom(a.x,a.y)},b.prototype.detachWall=function(b){a.Core.Utils.removeValue(this.wallStarts,b),a.Core.Utils.removeValue(this.wallEnds,b),0==this.wallStarts.length&&0==this.wallEnds.length&&this.remove()},b.prototype.attachStart=function(a){this.wallStarts.push(a)},b.prototype.attachEnd=function(a){this.wallEnds.push(a)},b.prototype.wallTo=function(a){for(var b=0;b<this.wallStarts.length;b++)if(this.wallStarts[b].getEnd()===a)return this.wallStarts[b];return null},b.prototype.wallFrom=function(a){for(var b=0;b<this.wallEnds.length;b++)if(this.wallEnds[b].getStart()===a)return this.wallEnds[b];return null},b.prototype.wallToOrFrom=function(a){return this.wallTo(a)||this.wallFrom(a)},b.prototype.combineWithCorner=function(a){this.x=a.x,this.y=a.y;for(var b=a.wallStarts.length-1;b>=0;b--)a.wallStarts[b].setStart(this);for(var b=a.wallEnds.length-1;b>=0;b--)a.wallEnds[b].setEnd(this);a.removeAll(),this.removeDuplicateWalls(),this.floorplan.update()},b.prototype.mergeWithIntersected=function(){for(var b=0;b<this.floorplan.getCorners().length;b++){var d=this.floorplan.getCorners()[b];if(this.distanceFromCorner(d)<c&&d!=this)return this.combineWithCorner(d),!0}for(var b=0;b<this.floorplan.getWalls().length;b++){var e=this.floorplan.getWalls()[b];if(this.distanceFromWall(e)<c&&!this.isWallConnected(e)){var f=a.Core.Utils.closestPointOnLine(this.x,this.y,e.getStart().x,e.getStart().y,e.getEnd().x,e.getEnd().y);return this.x=f.x,this.y=f.y,this.floorplan.newWall(this,e.getEnd()),e.setEnd(this),this.floorplan.update(),!0}}return!1},b.prototype.removeDuplicateWalls=function(){for(var a={},b={},c=this.wallStarts.length-1;c>=0;c--)this.wallStarts[c].getEnd()===this?this.wallStarts[c].remove():this.wallStarts[c].getEnd().id in a?this.wallStarts[c].remove():a[this.wallStarts[c].getEnd().id]=!0;for(var c=this.wallEnds.length-1;c>=0;c--)this.wallEnds[c].getStart()===this?this.wallEnds[c].remove():this.wallEnds[c].getStart().id in b?this.wallEnds[c].remove():b[this.wallEnds[c].getStart().id]=!0},b}();b.Corner=d}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=function(){function b(a,b,c){this.room=a,this.wall=b,this.front=c,this.plane=null,this.interiorTransform=new THREE.Matrix4,this.invInteriorTransform=new THREE.Matrix4,this.exteriorTransform=new THREE.Matrix4,this.invExteriorTransform=new THREE.Matrix4,this.redrawCallbacks=$.Callbacks(),this.generatePlane=function(){function a(a){return new THREE.Vector3(a.x,0,a.y)}var b=a(this.interiorStart()),c=a(this.interiorEnd()),d=c.clone();d.y=this.wall.height;var e=b.clone();e.y=this.wall.height;var f=new THREE.Geometry;f.vertices=[b,c,d,e],f.faces.push(new THREE.Face3(0,1,2)),f.faces.push(new THREE.Face3(0,2,3)),f.computeFaceNormals(),f.computeBoundingBox(),this.plane=new THREE.Mesh(f,new THREE.MeshBasicMaterial),this.plane.visible=!1,this.plane.edge=this,this.computeTransforms(this.interiorTransform,this.invInteriorTransform,this.interiorStart(),this.interiorEnd()),this.computeTransforms(this.exteriorTransform,this.invExteriorTransform,this.exteriorStart(),this.exteriorEnd())},this.front=c||!1,this.offset=b.thickness/2,this.height=b.height,this.front?this.wall.frontEdge=this:this.wall.backEdge=this}return b.prototype.getTexture=function(){return this.front?this.wall.frontTexture:this.wall.backTexture},b.prototype.setTexture=function(a,b,c){var d={url:a,stretch:b,scale:c};this.front?this.wall.frontTexture=d:this.wall.backTexture=d,this.redrawCallbacks.fire()},b.prototype.interiorDistance=function(){var b=this.interiorStart(),c=this.interiorEnd();return a.Core.Utils.distance(b.x,b.y,c.x,c.y)},b.prototype.computeTransforms=function(b,c,d,e){var f=d,g=e,h=a.Core.Utils.angle(1,0,g.x-f.x,g.y-f.y),i=new THREE.Matrix4;i.makeTranslation(-f.x,0,-f.y);var j=new THREE.Matrix4;j.makeRotationY(-h),b.multiplyMatrices(j,i),c.getInverse(b)},b.prototype.distanceTo=function(b,c){return a.Core.Utils.pointDistanceFromLine(b,c,this.interiorStart().x,this.interiorStart().y,this.interiorEnd().x,this.interiorEnd().y)},b.prototype.getStart=function(){return this.front?this.wall.getStart():this.wall.getEnd()},b.prototype.getEnd=function(){return this.front?this.wall.getEnd():this.wall.getStart()},b.prototype.getOppositeEdge=function(){return this.front?this.wall.backEdge:this.wall.frontEdge},b.prototype.interiorEnd=function(){var a=this.halfAngleVector(this,this.next);return{x:this.getEnd().x+a.x,y:this.getEnd().y+a.y}},b.prototype.interiorStart=function(){var a=this.halfAngleVector(this.prev,this);return{x:this.getStart().x+a.x,y:this.getStart().y+a.y}},b.prototype.interiorCenter=function(){return{x:(this.interiorStart().x+this.interiorEnd().x)/2,y:(this.interiorStart().y+this.interiorEnd().y)/2}},b.prototype.exteriorEnd=function(){var a=this.halfAngleVector(this,this.next);return{x:this.getEnd().x-a.x,y:this.getEnd().y-a.y}},b.prototype.exteriorStart=function(){var a=this.halfAngleVector(this.prev,this);return{x:this.getStart().x-a.x,y:this.getStart().y-a.y}},b.prototype.corners=function(){return[this.interiorStart(),this.interiorEnd(),this.exteriorEnd(),this.exteriorStart()]},b.prototype.halfAngleVector=function(b,c){if(b)var d=b.getStart().x,e=b.getStart().y,f=b.getEnd().x,g=b.getEnd().y;else var d=c.getStart().x-(c.getEnd().x-c.getStart().x),e=c.getStart().y-(c.getEnd().y-c.getStart().y),f=c.getStart().x,g=c.getStart().y;if(c)var h=c.getStart().x,i=c.getStart().y,j=c.getEnd().x,k=c.getEnd().y;else var h=b.getEnd().x,i=b.getEnd().y,j=b.getEnd().x+(b.getEnd().x-b.getStart().x),k=b.getEnd().y+(b.getEnd().y-b.getStart().y);var l=a.Core.Utils.angle2pi(d-f,e-g,j-f,k-g),m=Math.cos(l/2),n=Math.sin(l/2),o=j-h,p=k-i,q=o*m-p*n,r=o*n+p*m,s=a.Core.Utils.distance(0,0,q,r),t=this.offset/n,u=t/s,v={x:q*u,y:r*u};return v},b}();b.HalfEdge=c}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c={url:"rooms/textures/wallmap.png",stretch:!0,scale:0},d=function(){function b(b,d){this.start=b,this.end=d,this.frontEdge=null,this.backEdge=null,this.orphan=!1,this.items=[],this.onItems=[],this.frontTexture=c,this.backTexture=c,this.thickness=a.Core.Configuration.getNumericValue(a.Core.configWallThickness),this.height=a.Core.Configuration.getNumericValue(a.Core.configWallHeight),this.moved_callbacks=$.Callbacks(),this.deleted_callbacks=$.Callbacks(),this.action_callbacks=$.Callbacks(),this.id=this.getUuid(),this.start.attachStart(this),this.end.attachEnd(this)}return b.prototype.getUuid=function(){return[this.start.id,this.end.id].join()},b.prototype.resetFrontBack=function(){this.frontEdge=null,this.backEdge=null,this.orphan=!1},b.prototype.snapToAxis=function(a){this.start.snapToAxis(a),this.end.snapToAxis(a)},b.prototype.fireOnMove=function(a){this.moved_callbacks.add(a)},b.prototype.fireOnDelete=function(a){this.deleted_callbacks.add(a)},b.prototype.dontFireOnDelete=function(a){this.deleted_callbacks.remove(a)},b.prototype.fireOnAction=function(a){this.action_callbacks.add(a)},b.prototype.fireAction=function(a){this.action_callbacks.fire(a)},b.prototype.relativeMove=function(a,b){this.start.relativeMove(a,b),this.end.relativeMove(a,b)},b.prototype.fireMoved=function(){this.moved_callbacks.fire()},b.prototype.fireRedraw=function(){this.frontEdge&&this.frontEdge.redrawCallbacks.fire(),this.backEdge&&this.backEdge.redrawCallbacks.fire()},b.prototype.getStart=function(){return this.start},b.prototype.getEnd=function(){return this.end},b.prototype.getStartX=function(){return this.start.getX()},b.prototype.getEndX=function(){return this.end.getX()},b.prototype.getStartY=function(){return this.start.getY()},b.prototype.getEndY=function(){return this.end.getY()},b.prototype.remove=function(){this.start.detachWall(this),this.end.detachWall(this),this.deleted_callbacks.fire(this)},b.prototype.setStart=function(a){this.start.detachWall(this),a.attachStart(this),this.start=a,this.fireMoved()},b.prototype.setEnd=function(a){this.end.detachWall(this),a.attachEnd(this),this.end=a,this.fireMoved()},b.prototype.distanceFrom=function(b,c){return a.Core.Utils.pointDistanceFromLine(b,c,this.getStartX(),this.getStartY(),this.getEndX(),this.getEndY())},b.prototype.oppositeCorner=function(a){return this.start===a?this.end:this.end===a?this.start:void console.log("Wall does not connect to corner")},b}();b.Wall=d}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c={url:"rooms/textures/hardwood.png",scale:400},d=function(){function d(a,b){this.floorplan=a,this.corners=b,this.interiorCorners=[],this.edgePointer=null,this.floorPlane=null,this.customTexture=!1,this.floorChangeCallbacks=$.Callbacks(),this.updateWalls(),this.updateInteriorCorners(),this.generatePlane()}return d.prototype.getUuid=function(){var b=a.Core.Utils.map(this.corners,function(a){return a.id});return b.sort(),b.join()},d.prototype.fireOnFloorChange=function(a){this.floorChangeCallbacks.add(a)},d.prototype.getTexture=function(){var a=this.getUuid(),b=this.floorplan.getFloorTexture(a);return b||c},d.prototype.setTexture=function(a,b,c){var d=this.getUuid();this.floorplan.setFloorTexture(d,a,c),this.floorChangeCallbacks.fire()},d.prototype.generatePlane=function(){var a=[];this.interiorCorners.forEach(function(b){a.push(new THREE.Vector2(b.x,b.y))});var b=new THREE.Shape(a),c=new THREE.ShapeGeometry(b);this.floorPlane=new THREE.Mesh(c,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})),this.floorPlane.visible=!1,this.floorPlane.rotation.set(Math.PI/2,0,0),this.floorPlane.room=this},d.prototype.cycleIndex=function(a){return a<0?a+=this.corners.length:a%this.corners.length},d.prototype.updateInteriorCorners=function(){for(var a=this.edgePointer;;){if(this.interiorCorners.push(a.interiorStart()),a.generatePlane(),a.next===this.edgePointer)break;a=a.next}},d.prototype.updateWalls=function(){for(var a=null,c=null,d=0;d<this.corners.length;d++){var e=this.corners[d],f=this.corners[(d+1)%this.corners.length],g=e.wallTo(f),h=e.wallFrom(f);if(g)var i=new b.HalfEdge(this,g,(!0));else if(h)var i=new b.HalfEdge(this,h,(!1));else console.log("corners arent connected by a wall, uh oh");0==d?c=i:(i.prev=a,a.next=i,d+1==this.corners.length&&(c.prev=i,i.next=c)),a=i}this.edgePointer=c},d}();b.Room=d}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=10,d=function(){function d(){this.walls=[],this.corners=[],this.rooms=[],this.new_wall_callbacks=$.Callbacks(),this.new_corner_callbacks=$.Callbacks(),this.redraw_callbacks=$.Callbacks(),this.updated_rooms=$.Callbacks(),this.roomLoadedCallbacks=$.Callbacks(),this.floorTextures={}}return d.prototype.wallEdges=function(){var a=[];return this.walls.forEach(function(b){b.frontEdge&&a.push(b.frontEdge),b.backEdge&&a.push(b.backEdge)}),a},d.prototype.wallEdgePlanes=function(){var a=[];return this.walls.forEach(function(b){b.frontEdge&&a.push(b.frontEdge.plane),b.backEdge&&a.push(b.backEdge.plane)}),a},d.prototype.floorPlanes=function(){return a.Core.Utils.map(this.rooms,function(a){return a.floorPlane})},d.prototype.fireOnNewWall=function(a){this.new_wall_callbacks.add(a)},d.prototype.fireOnNewCorner=function(a){this.new_corner_callbacks.add(a)},d.prototype.fireOnRedraw=function(a){this.redraw_callbacks.add(a)},d.prototype.fireOnUpdatedRooms=function(a){this.updated_rooms.add(a)},d.prototype.newWall=function(a,c){var d=new b.Wall(a,c);this.walls.push(d);var e=this;return d.fireOnDelete(function(){e.removeWall(d)}),this.new_wall_callbacks.fire(d),this.update(),d},d.prototype.removeWall=function(b){a.Core.Utils.removeValue(this.walls,b),this.update()},d.prototype.newCorner=function(a,c,d){var e=this,f=new b.Corner(this,a,c,d);return this.corners.push(f),f.fireOnDelete(function(){e.removeCorner}),this.new_corner_callbacks.fire(f),f},d.prototype.removeCorner=function(b){a.Core.Utils.removeValue(this.corners,b)},d.prototype.getWalls=function(){return this.walls},d.prototype.getCorners=function(){return this.corners},d.prototype.getRooms=function(){return this.rooms},d.prototype.overlappedCorner=function(a,b,d){d=d||c;for(var e=0;e<this.corners.length;e++)if(this.corners[e].distanceFrom(a,b)<d)return this.corners[e];return null},d.prototype.overlappedWall=function(a,b,d){d=d||c;for(var e=0;e<this.walls.length;e++)if(this.walls[e].distanceFrom(a,b)<d)return this.walls[e];return null},d.prototype.saveFloorplan=function(){var a={corners:{},walls:[],wallTextures:[],floorTextures:{},newFloorTextures:{}};return this.corners.forEach(function(b){a.corners[b.id]={x:b.x,y:b.y}}),this.walls.forEach(function(b){a.walls.push({corner1:b.getStart().id,corner2:b.getEnd().id,frontTexture:b.frontTexture,backTexture:b.backTexture})}),a.newFloorTextures=this.floorTextures,a},d.prototype.loadFloorplan=function(a){this.reset();var b={};if(null!=a&&"corners"in a&&"walls"in a){for(var c in a.corners){var d=a.corners[c];b[c]=this.newCorner(d.x,d.y,c)}var e=this;a.walls.forEach(function(a){var c=e.newWall(b[a.corner1],b[a.corner2]);a.frontTexture&&(c.frontTexture=a.frontTexture),a.backTexture&&(c.backTexture=a.backTexture)}),"newFloorTextures"in a&&(this.floorTextures=a.newFloorTextures),this.update(),this.roomLoadedCallbacks.fire()}},d.prototype.getFloorTexture=function(a){return a in this.floorTextures?this.floorTextures[a]:null},d.prototype.setFloorTexture=function(a,b,c){this.floorTextures[a]={url:b,scale:c}},d.prototype.updateFloorTextures=function(){var b=a.Core.Utils.map(this.rooms,function(a){return a.getUuid()});for(var c in this.floorTextures)a.Core.Utils.hasValue(b,c)||delete this.floorTextures[c]},d.prototype.reset=function(){var a=this.corners.slice(0),b=this.walls.slice(0);a.forEach(function(a){a.remove()}),b.forEach(function(a){a.remove()}),this.corners=[],this.walls=[]},d.prototype.update=function(){this.walls.forEach(function(a){a.resetFrontBack()});var a=this.findRooms(this.corners);this.rooms=[];var c=this;a.forEach(function(a){c.rooms.push(new b.Room(c,a))}),this.assignOrphanEdges(),this.updateFloorTextures(),this.updated_rooms.fire()},d.prototype.getCenter=function(){return this.getDimensions(!0)},d.prototype.getSize=function(){return this.getDimensions(!1)},d.prototype.getDimensions=function(a){a=a||!1;var b=1/0,c=-(1/0),d=1/0,e=-(1/0);this.corners.forEach(function(a){a.x<b&&(b=a.x),a.x>c&&(c=a.x),a.y<d&&(d=a.y),a.y>e&&(e=a.y)});var f;return f=b==1/0||c==-(1/0)||d==1/0||e==-(1/0)?new THREE.Vector3:a?new THREE.Vector3(.5*(b+c),0,.5*(d+e)):new THREE.Vector3(c-b,0,e-d)},d.prototype.assignOrphanEdges=function(){var a=[];this.walls.forEach(function(c){if(!c.backEdge&&!c.frontEdge){c.orphan=!0;var d=new b.HalfEdge(null,c,(!1));d.generatePlane();var e=new b.HalfEdge(null,c,(!0));e.generatePlane(),a.push(c)}})},d.prototype.findRooms=function(b){function c(b,c,d){var e=a.Core.Utils.angle2pi(b.x-c.x,b.y-c.y,d.x-c.x,d.y-c.y);return e}function d(b){for(var c=[],d={},e=function(a){return a.id},f="-",g=0;g<b.length;g++){for(var h=!0,i=b[g],j=0;j<i.length;j++){var k=a.Core.Utils.cycle(i,j),l=a.Core.Utils.map(k,e).join(f);d.hasOwnProperty(l)&&(h=!1)}h&&(c.push(b[g]),d[l]=!0)}return c}function e(a,b){var d=[],e={corner:b,previousCorners:[a]},f={};for(f[a.id]=!0;e;){var g=e.corner;if(f[g.id]=!0,e.corner===a&&g!==b)return e.previousCorners;for(var h=[],i=e.corner.adjacentCorners(),j=0;j<i.length;j++){var k=i[j];k.id in f&&(k!==a||g===b)||h.push(k)}var l=e.previousCorners.slice(0);if(l.push(g),h.length>1){var m=e.previousCorners[e.previousCorners.length-1];h.sort(function(a,b){return c(m,g,b)-c(m,g,a)})}h.length>0&&h.forEach(function(a){d.push({corner:a,previousCorners:l})}),e=d.pop()}return[]}var f=[];b.forEach(function(a){a.adjacentCorners().forEach(function(b){f.push(e(a,b))})});var g=d(f),h=a.Core.Utils.removeIf(g,a.Core.Utils.isClockwise);return h},d}();b.Floorplan=d}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=function(b){function c(a,c,d,e,f,g,h){b.call(this,a,c,d,e,f,g,h)}return __extends(c,b),c.prototype.placeInRoom=function(){if(!this.position_set){var a=this.model.floorplan.getCenter();this.position.x=a.x,this.position.z=a.z,this.position.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)}},c.prototype.resized=function(){this.position.y=this.halfSize.y},c.prototype.moveToPosition=function(a,b){return this.isValidPosition(a)?(this.hideError(),a.y=this.position.y,this.position.copy(a),void 0):void this.showError(a)},c.prototype.isValidPosition=function(b){for(var c=this.getCorners("x","z",b),d=this.model.floorplan.getRooms(),e=!1,f=0;f<d.length;f++)a.Core.Utils.pointInPolygon(b.x,b.z,d[f].interiorCorners)&&!a.Core.Utils.polygonPolygonIntersect(c,d[f].interiorCorners)&&(e=!0);return!!e},c}(b.Item);b.FloorItem=c}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=function(b){function c(a,c,d,e,f,g,h){b.call(this,a,c,d,e,f,g,h),this.currentWallEdge=null,this.refVec=new THREE.Vector2(0,1),this.wallOffsetScalar=0,this.sizeX=0,this.sizeY=0,this.addToWall=!1,this.boundToFloor=!1,this.frontVisible=!1,this.backVisible=!1,this.allowRotate=!1}return __extends(c,b),c.prototype.closestWallEdge=function(){var a=this.model.floorplan.wallEdges(),b=null,c=null,d=this.position.x,e=this.position.z;return a.forEach(function(a){var f=a.distanceTo(d,e);(null===c||f<c)&&(c=f,b=a)}),b},c.prototype.removed=function(){null!=this.currentWallEdge&&this.addToWall&&(a.Core.Utils.removeValue(this.currentWallEdge.wall.items,this),this.redrawWall())},c.prototype.redrawWall=function(){this.addToWall&&this.currentWallEdge.wall.fireRedraw()},c.prototype.updateEdgeVisibility=function(a,b){b?this.frontVisible=a:this.backVisible=a,this.visible=this.frontVisible||this.backVisible},c.prototype.updateSize=function(){this.wallOffsetScalar=(this.geometry.boundingBox.max.z-this.geometry.boundingBox.min.z)*this.scale.z/2,this.sizeX=(this.geometry.boundingBox.max.x-this.geometry.boundingBox.min.x)*this.scale.x,this.sizeY=(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)*this.scale.y},c.prototype.resized=function(){this.boundToFloor&&(this.position.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)*this.scale.y+.01),this.updateSize(),this.redrawWall()},c.prototype.placeInRoom=function(){var a=this.closestWallEdge();if(this.changeWallEdge(a),this.updateSize(),!this.position_set){var b=a.interiorCenter(),c=new THREE.Vector3(b.x,a.wall.height/2,b.y);this.boundMove(c),this.position.copy(c),this.redrawWall()}},c.prototype.moveToPosition=function(a,b){this.changeWallEdge(b.object.edge),this.boundMove(a),this.position.copy(a),this.redrawWall()},c.prototype.getWallOffset=function(){return this.wallOffsetScalar},c.prototype.changeWallEdge=function(b){null!=this.currentWallEdge&&(this.addToWall?(a.Core.Utils.removeValue(this.currentWallEdge.wall.items,this),this.redrawWall()):a.Core.Utils.removeValue(this.currentWallEdge.wall.onItems,this)),null!=this.currentWallEdge&&this.currentWallEdge.wall.dontFireOnDelete(this.remove.bind(this)),b.wall.fireOnDelete(this.remove.bind(this));var c=new THREE.Vector2,d=b.plane.geometry.faces[0].normal;c.x=d.x,c.y=d.z;var e=a.Core.Utils.angle(this.refVec.x,this.refVec.y,c.x,c.y);this.rotation.y=e,this.currentWallEdge=b,this.addToWall?(b.wall.items.push(this),this.redrawWall()):b.wall.onItems.push(this)},c.prototype.customIntersectionPlanes=function(){return this.model.floorplan.wallEdgePlanes()},c.prototype.boundMove=function(a){var b=1,c=this.currentWallEdge;a.applyMatrix4(c.interiorTransform),a.x<this.sizeX/2+b?a.x=this.sizeX/2+b:a.x>c.interiorDistance()-this.sizeX/2-b&&(a.x=c.interiorDistance()-this.sizeX/2-b),this.boundToFloor?a.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)*this.scale.y+.01:a.y<this.sizeY/2+b?a.y=this.sizeY/2+b:a.y>c.height-this.sizeY/2-b&&(a.y=c.height-this.sizeY/2-b),a.z=this.getWallOffset(),a.applyMatrix4(c.invInteriorTransform)},c}(b.Item);b.WallItem=c}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f,g,h){a.call(this,b,c,d,e,f,g,h),this.addToWall=!0}return __extends(b,a),b.prototype.getWallOffset=function(){return-this.currentWallEdge.offset+.5},b}(a.WallItem);a.InWallItem=b}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f,g,h){a.call(this,b,c,d,e,f,g,h),this.boundToFloor=!0}return __extends(b,a),b}(a.InWallItem);a.InWallFloorItem=b}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=function(b){function c(a,c,d,e,f,g,h){b.call(this,a,c,d,e,f,g,h)}return __extends(c,b),c.prototype.placeInRoom=function(){if(!this.position_set){var a=this.model.floorplan.getCenter();this.position.x=a.x,this.position.z=a.z,this.position.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y)}},c.prototype.resized=function(){},c.prototype.moveToPosition=function(a,b){return this.isValidPosition(a)?(this.hideError(),a.y=this.position.y,this.position.copy(a),void 0):void this.showError(a)},c.prototype.isValidPosition=function(b){for(var c=this.getCorners("x","z",b),d=this.model.floorplan.getRooms(),e=!1,f=0;f<d.length;f++)a.Core.Utils.pointInPolygon(b.x,b.z,d[f].interiorCorners)&&!a.Core.Utils.polygonPolygonIntersect(c,d[f].interiorCorners)&&(e=!0);return!!e&&(this.spaceCheck(),!0)},c.prototype.spaceCheck=function(){
var a=this.model.scene.getItems();this.position.y=.5*(this.geometry.boundingBox.max.y-this.geometry.boundingBox.min.y);for(var b=0;b<a.length;b++)if(this.uuid!==a[b].uuid){var c={selected:{x:{start:this.position.x-this.halfSize.x,end:this.position.x+this.halfSize.x},z:{start:this.position.z+this.halfSize.z,end:this.position.z-this.halfSize.z}},other:{x:{start:a[b].position.x-a[b].halfSize.x,end:a[b].position.x+a[b].halfSize.x},z:{start:a[b].position.z+a[b].halfSize.z,end:a[b].position.z-a[b].halfSize.z}}},d={from:c.selected.x.start<c.other.x.end&&c.selected.x.end>c.other.x.start,to:c.selected.z.start>c.other.z.end&&c.selected.z.end<c.other.z.start};d.from&&d.to&&(this.position.y=a[b].position.y+a[b].getHeight())}},c}(b.Item);b.DeviceItem=c}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f,g,h){a.call(this,b,c,d,e,f,g,h),this.obstructFloorMoves=!1,this.receiveShadow=!0}return __extends(b,a),b}(a.FloorItem);a.OnFloorItem=b}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=function(a){function b(b,c,d,e,f,g,h){a.call(this,b,c,d,e,f,g,h),this.boundToFloor=!0}return __extends(b,a),b}(a.WallItem);a.WallFloorItem=b}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b={1:a.FloorItem,2:a.WallItem,3:a.InWallItem,4:a.DeviceItem,7:a.InWallFloorItem,8:a.OnFloorItem,9:a.WallFloorItem},c=function(){function a(){}return a.getClass=function(a){return b[a]},a}();a.Factory=c}(b=a.Items||(a.Items={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){var c=function(){function b(a,b){this.model=a,this.textureDir=b,this.items=[],this.needsUpdate=!1,this.itemLoadingCallbacks=$.Callbacks(),this.itemLoadedCallbacks=$.Callbacks(),this.itemRemovedCallbacks=$.Callbacks(),this.scene=new THREE.Scene,this.loader=new THREE.JSONLoader,this.loader.crossOrigin="",this.loader2=new THREE.OBJLoader2}return b.prototype.add=function(a){this.scene.add(a)},b.prototype.remove=function(b){this.scene.remove(b),a.Core.Utils.removeValue(this.items,b)},b.prototype.getScene=function(){return this.scene},b.prototype.getItems=function(){return this.items},b.prototype.itemCount=function(){return this.items.length},b.prototype.clearItems=function(){var a=(this.items,this);this.items.forEach(function(b){a.removeItem(b,!0)}),this.items=[]},b.prototype.removeItem=function(b,c){c=c||!1,this.itemRemovedCallbacks.fire(b),b.removed(),this.scene.remove(b),c||a.Core.Utils.removeValue(this.items,b)},b.prototype.addItem=function(a,b,c,d,e,f,g){a=a||1;var h=function(){};console.log("=====> fileName: ",b),this.itemLoadingCallbacks.fire(),this.loader2.load(b,h,null,null,null)},b}();b.Scene=c}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=function(){function b(b){this.roomLoadingCallbacks=$.Callbacks(),this.roomLoadedCallbacks=$.Callbacks(),this.roomSavedCallbacks=$.Callbacks(),this.roomDeletedCallbacks=$.Callbacks(),this.floorplan=new a.Floorplan,this.scene=new a.Scene(this,b)}return b.prototype.loadSerialized=function(a){this.roomLoadingCallbacks.fire();var b=JSON.parse(a);this.newRoom(b.floorplan,b.items),this.roomLoadedCallbacks.fire()},b.prototype.exportSerialized=function(){for(var a=[],b=this.scene.getItems(),c=0;c<b.length;c++){var d=b[c];a[c]={item_name:d.metadata.itemName,item_type:d.metadata.itemType,model_url:d.metadata.modelUrl,model_code:d.metadata.modelCode,xpos:d.position.x,ypos:d.position.y,zpos:d.position.z,rotation:d.rotation.y,scale_x:d.scale.x,scale_y:d.scale.y,scale_z:d.scale.z,fixed:d.fixed}}var e={floorplan:this.floorplan.saveFloorplan(),items:a};return JSON.stringify(e)},b.prototype.newRoom=function(a,b){var c=this;this.scene.clearItems(),this.floorplan.loadFloorplan(a),b.forEach(function(a){var b=new THREE.Vector3(a.xpos,a.ypos,a.zpos),d={itemName:a.item_name,resizable:a.resizable,itemType:a.item_type,modelUrl:a.model_url,modelCode:a.model_code},e=new THREE.Vector3(a.scale_x,a.scale_y,a.scale_z);c.scene.addItem(a.item_type,a.model_url,d,b,a.rotation,e,a.fixed)})},b}();a.Model=b}(b=a.Model||(a.Model={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){b.floorplannerModes={MOVE:0,DRAW:1,DELETE:2};var c=20,d=1,e="#f1f1f1",f="#f9f9f9",g=5,h=7,i="#dddddd",j="#008cba",k="#888888",l="#008cba",m=1,n="#ff0000",o=0,p=7,q="#cccccc",r="#008cba",s=function(){function s(a,b,c){this.floorplan=a,this.viewmodel=b,this.canvas=c,this.canvasElement=document.getElementById(c),this.context=this.canvasElement.getContext("2d");var d=this;$(window).resize(function(){d.handleWindowResize()}),this.handleWindowResize()}return s.prototype.handleWindowResize=function(){var a=$("#"+this.canvas),b=a.parent();a.height(b.innerHeight()),a.width(b.innerWidth()),this.canvasElement.height=b.innerHeight(),this.canvasElement.width=b.innerWidth(),this.draw()},s.prototype.draw=function(){var a=this;this.context.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.drawGrid(),this.floorplan.getRooms().forEach(function(b){a.drawRoom(b)}),this.floorplan.getWalls().forEach(function(b){a.drawWall(b)}),this.floorplan.getCorners().forEach(function(b){a.drawCorner(b)}),this.viewmodel.mode==b.floorplannerModes.DRAW&&this.drawTarget(this.viewmodel.targetX,this.viewmodel.targetY,this.viewmodel.lastNode),this.floorplan.getWalls().forEach(function(b){a.drawWallLabels(b)})},s.prototype.drawWallLabels=function(a){a.backEdge&&a.frontEdge?a.backEdge.interiorDistance<a.frontEdge.interiorDistance?this.drawEdgeLabel(a.backEdge):this.drawEdgeLabel(a.frontEdge):a.backEdge?this.drawEdgeLabel(a.backEdge):a.frontEdge&&this.drawEdgeLabel(a.frontEdge)},s.prototype.drawWall=function(a){var c=a===this.viewmodel.activeWall,d=i;c&&this.viewmodel.mode==b.floorplannerModes.DELETE?d=n:c&&(d=j),this.drawLine(this.viewmodel.convertX(a.getStartX()),this.viewmodel.convertY(a.getStartY()),this.viewmodel.convertX(a.getEndX()),this.viewmodel.convertY(a.getEndY()),c?h:g,d),!c&&a.frontEdge&&this.drawEdge(a.frontEdge,c),!c&&a.backEdge&&this.drawEdge(a.backEdge,c)},s.prototype.drawEdgeLabel=function(b){var c=b.interiorCenter(),d=b.interiorDistance();d<60||(this.context.font="normal 12px Arial",this.context.fillStyle="#000000",this.context.textBaseline="middle",this.context.textAlign="center",this.context.strokeStyle="#ffffff",this.context.lineWidth=4,this.context.strokeText(a.Core.Dimensioning.cmToMeasure(d),this.viewmodel.convertX(c.x),this.viewmodel.convertY(c.y)),this.context.fillText(a.Core.Dimensioning.cmToMeasure(d),this.viewmodel.convertX(c.x),this.viewmodel.convertY(c.y)))},s.prototype.drawEdge=function(c,d){var e=k;d&&this.viewmodel.mode==b.floorplannerModes.DELETE?e=n:d&&(e=l);var f=c.corners(),g=this;this.drawPolygon(a.Core.Utils.map(f,function(a){return g.viewmodel.convertX(a.x)}),a.Core.Utils.map(f,function(a){return g.viewmodel.convertY(a.y)}),!1,null,!0,e,m)},s.prototype.drawRoom=function(b){var c=this;this.drawPolygon(a.Core.Utils.map(b.corners,function(a){return c.viewmodel.convertX(a.x)}),a.Core.Utils.map(b.corners,function(a){return c.viewmodel.convertY(a.y)}),!0,f)},s.prototype.drawCorner=function(a){var c=a===this.viewmodel.activeCorner,d=q;c&&this.viewmodel.mode==b.floorplannerModes.DELETE?d=n:c&&(d=r),this.drawCircle(this.viewmodel.convertX(a.x),this.viewmodel.convertY(a.y),c?p:o,d)},s.prototype.drawTarget=function(a,b,c){this.drawCircle(this.viewmodel.convertX(a),this.viewmodel.convertY(b),p,r),this.viewmodel.lastNode&&this.drawLine(this.viewmodel.convertX(c.x),this.viewmodel.convertY(c.y),this.viewmodel.convertX(a),this.viewmodel.convertY(b),h,j)},s.prototype.drawLine=function(a,b,c,d,e,f){this.context.beginPath(),this.context.moveTo(a,b),this.context.lineTo(c,d),this.context.lineWidth=e,this.context.strokeStyle=f,this.context.stroke()},s.prototype.drawPolygon=function(a,b,c,d,e,f,g){c=c||!1,e=e||!1,this.context.beginPath(),this.context.moveTo(a[0],b[0]);for(var h=1;h<a.length;h++)this.context.lineTo(a[h],b[h]);this.context.closePath(),c&&(this.context.fillStyle=d,this.context.fill()),e&&(this.context.lineWidth=g,this.context.strokeStyle=f,this.context.stroke())},s.prototype.drawCircle=function(a,b,c,d){this.context.beginPath(),this.context.arc(a,b,c,0,2*Math.PI,!1),this.context.fillStyle=d,this.context.fill()},s.prototype.calculateGridOffset=function(a){return a>=0?(a+c/2)%c-c/2:(a-c/2)%c+c/2},s.prototype.drawGrid=function(){for(var a=this.calculateGridOffset(-this.viewmodel.originX),b=this.calculateGridOffset(-this.viewmodel.originY),f=this.canvasElement.width,g=this.canvasElement.height,h=0;h<=f/c;h++)this.drawLine(c*h+a,0,c*h+a,g,d,e);for(var i=0;i<=g/c;i++)this.drawLine(0,c*i+b,f,c*i+b,d,e)},s}();b.FloorplannerView=s}(b=a.Floorplanner||(a.Floorplanner={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=25,c=function(){function c(b,c){this.floorplan=c,this.mode=0,this.activeWall=null,this.activeCorner=null,this.originX=0,this.originY=0,this.targetX=0,this.targetY=0,this.lastNode=null,this.modeResetCallbacks=$.Callbacks(),this.mouseDown=!1,this.mouseMoved=!1,this.mouseX=0,this.mouseY=0,this.rawMouseX=0,this.rawMouseY=0,this.lastX=0,this.lastY=0,this.canvasElement=$("#"+b),this.view=new a.FloorplannerView(this.floorplan,this,b);var d=30.48,e=15;this.cmPerPixel=d*(1/e),this.pixelsPerCm=1/this.cmPerPixel,this.wallWidth=10*this.pixelsPerCm,this.setMode(a.floorplannerModes.MOVE);var f=this;this.canvasElement.mousedown(function(){f.mousedown()}),this.canvasElement.mousemove(function(a){f.mousemove(a)}),this.canvasElement.mouseup(function(){f.mouseup()}),this.canvasElement.mouseleave(function(){f.mouseleave()}),$(document).keyup(function(a){27==a.keyCode&&f.escapeKey()}),c.roomLoadedCallbacks.add(function(){f.reset()})}return c.prototype.escapeKey=function(){this.setMode(a.floorplannerModes.MOVE)},c.prototype.updateTarget=function(){this.mode==a.floorplannerModes.DRAW&&this.lastNode?(Math.abs(this.mouseX-this.lastNode.x)<b?this.targetX=this.lastNode.x:this.targetX=this.mouseX,Math.abs(this.mouseY-this.lastNode.y)<b?this.targetY=this.lastNode.y:this.targetY=this.mouseY):(this.targetX=this.mouseX,this.targetY=this.mouseY),this.view.draw()},c.prototype.mousedown=function(){this.mouseDown=!0,this.mouseMoved=!1,this.lastX=this.rawMouseX,this.lastY=this.rawMouseY,this.mode==a.floorplannerModes.DELETE&&(this.activeCorner?this.activeCorner.removeAll():this.activeWall?this.activeWall.remove():this.setMode(a.floorplannerModes.MOVE))},c.prototype.mousemove=function(c){if(this.mouseMoved=!0,this.rawMouseX=c.clientX,this.rawMouseY=c.clientY,this.mouseX=(c.clientX-this.canvasElement.offset().left)*this.cmPerPixel+this.originX*this.cmPerPixel,this.mouseY=(c.clientY-this.canvasElement.offset().top)*this.cmPerPixel+this.originY*this.cmPerPixel,(this.mode==a.floorplannerModes.DRAW||this.mode==a.floorplannerModes.MOVE&&this.mouseDown)&&this.updateTarget(),this.mode!=a.floorplannerModes.DRAW&&!this.mouseDown){var d=this.floorplan.overlappedCorner(this.mouseX,this.mouseY),e=this.floorplan.overlappedWall(this.mouseX,this.mouseY),f=!1;d!=this.activeCorner&&(this.activeCorner=d,f=!0),null==this.activeCorner?e!=this.activeWall&&(this.activeWall=e,f=!0):this.activeWall=null,f&&this.view.draw()}!this.mouseDown||this.activeCorner||this.activeWall||(this.originX+=this.lastX-this.rawMouseX,this.originY+=this.lastY-this.rawMouseY,this.lastX=this.rawMouseX,this.lastY=this.rawMouseY,this.view.draw()),this.mode==a.floorplannerModes.MOVE&&this.mouseDown&&(this.activeCorner?(this.activeCorner.move(this.mouseX,this.mouseY),this.activeCorner.snapToAxis(b)):this.activeWall&&(this.activeWall.relativeMove((this.rawMouseX-this.lastX)*this.cmPerPixel,(this.rawMouseY-this.lastY)*this.cmPerPixel),this.activeWall.snapToAxis(b),this.lastX=this.rawMouseX,this.lastY=this.rawMouseY),this.view.draw())},c.prototype.mouseup=function(){if(this.mouseDown=!1,this.mode==a.floorplannerModes.DRAW&&!this.mouseMoved){var b=this.floorplan.newCorner(this.targetX,this.targetY);null!=this.lastNode&&this.floorplan.newWall(this.lastNode,b),b.mergeWithIntersected()&&null!=this.lastNode&&this.setMode(a.floorplannerModes.MOVE),this.lastNode=b}},c.prototype.mouseleave=function(){this.mouseDown=!1},c.prototype.reset=function(){this.resizeView(),this.setMode(a.floorplannerModes.MOVE),this.resetOrigin(),this.view.draw()},c.prototype.resizeView=function(){this.view.handleWindowResize()},c.prototype.setMode=function(a){this.lastNode=null,this.mode=a,this.modeResetCallbacks.fire(a),this.updateTarget()},c.prototype.resetOrigin=function(){var a=this.canvasElement.innerWidth()/2,b=this.canvasElement.innerHeight()/2,c=this.floorplan.getCenter();this.originX=c.x*this.pixelsPerCm-a,this.originY=c.z*this.pixelsPerCm-b},c.prototype.convertX=function(a){return(a-this.originX*this.cmPerPixel)*this.pixelsPerCm},c.prototype.convertY=function(a){return(a-this.originY*this.cmPerPixel)*this.pixelsPerCm},c}();a.Floorplanner=c}(b=a.Floorplanner||(a.Floorplanner={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){b.Controller=function(b,c,d,e,f,g){function h(){e.mousedown(p),e.mouseup(q),e.mousemove(o),A=new THREE.Vector2,E.itemRemovedCallbacks.add(l),E.itemLoadedCallbacks.add(i),m()}function i(a){if(!a.position_set){y.setSelectedObject(a),r(I.DRAGGING);var c=a.position.clone();c.y=0;var d=b.projectVector(c);j(d)}a.position_set=!0}function j(a){a=a||A;var b=y.itemIntersection(A,D);b&&D.clickPressed(b)}function k(a){a=a||A;var b=y.itemIntersection(A,D);b&&(y.isRotating()?D.rotate(b):D.clickDragged(b))}function l(a){a===D&&(D.setUnselected(),D.mouseOff(),y.setSelectedObject(null))}function m(){var a=1e4;z=new THREE.Mesh(new THREE.PlaneGeometry(a,a),new THREE.MeshBasicMaterial),z.rotation.x=-Math.PI/2,z.visible=!1,E.add(z)}function n(a){if(J==I.UNSELECTED&&null==C){var d=c.floorplan.wallEdgePlanes(),e=y.getIntersections(A,d,!0);if(e.length>0){var f=e[0].object.edge;return void b.wallClicked.fire(f)}var g=c.floorplan.floorPlanes(),h=y.getIntersections(A,g,!1);if(h.length>0){var i=h[0].object.room;return void b.floorClicked.fire(i)}b.nothingClicked.fire()}}function o(a){if(y.enabled)switch(a.preventDefault(),G=!0,A.x=a.clientX,A.y=a.clientY,F||u(),J){case I.UNSELECTED:x();break;case I.SELECTED:x();break;case I.DRAGGING:case I.ROTATING:case I.ROTATING_FREE:k(),g.update(),y.needsUpdate=!0}}function p(a){if(y.enabled)switch(a.preventDefault(),G=!1,F=!0,J){case I.SELECTED:H?r(I.ROTATING):null!=B&&(y.setSelectedObject(B),B.fixed||r(I.DRAGGING));break;case I.UNSELECTED:null!=B&&(y.setSelectedObject(B),B.fixed||r(I.DRAGGING));break;case I.DRAGGING:case I.ROTATING:break;case I.ROTATING_FREE:r(I.SELECTED)}}function q(a){if(y.enabled)switch(F=!1,J){case I.DRAGGING:D.clickReleased(),r(I.SELECTED);break;case I.ROTATING:r(G?I.SELECTED:I.ROTATING_FREE);break;case I.UNSELECTED:G||n();break;case I.SELECTED:null!=B||G||(r(I.UNSELECTED),n());break;case I.ROTATING_FREE:}}function r(a){a!=J&&(t(J),s(a)),J=a,g.setRotating(y.isRotating())}function s(a){switch(a){case I.UNSELECTED:y.setSelectedObject(null);case I.SELECTED:f.enabled=!0;break;case I.ROTATING:case I.ROTATING_FREE:f.enabled=!1;break;case I.DRAGGING:b.setCursorStyle("move"),j(),f.enabled=!1}}function t(a){switch(a){case I.UNSELECTED:case I.SELECTED:break;case I.DRAGGING:C?b.setCursorStyle("pointer"):b.setCursorStyle("auto");break;case I.ROTATING:case I.ROTATING_FREE:}}function u(){var a=g.getObject();if(null!=a){var b=y.getIntersections(A,a,!1,!1,!0);if(b.length>0)return H=!0,g.setMouseover(!0),void(B=null)}H=!1,g.setMouseover(!1);var d=c.scene.getItems(),e=y.getIntersections(A,d,!1,!0);B=e.length>0?e[0].object:null}function v(a){var c=new THREE.Vector2;return c.x=(a.x-b.widthMargin)/(window.innerWidth-b.widthMargin)*2-1,c.y=2*-((a.y-b.heightMargin)/(window.innerHeight-b.heightMargin))+1,c}function w(a){var b=v(a),c=new THREE.Vector3(b.x,b.y,.5);return c.unproject(d),c}function x(){null!=B?null!=C?C!==B&&(C.mouseOff(),C=B,C.mouseOver(),y.needsUpdate=!0):(C=B,C.mouseOver(),b.setCursorStyle("pointer"),y.needsUpdate=!0):null!=C&&(C.mouseOff(),b.setCursorStyle("auto"),C=null,y.needsUpdate=!0)}var y=this;this.enabled=!0;var z,A,B,C,D,b=b,c=c,E=c.scene,e=e,d=d,f=f,g=g,F=!1,G=!1,H=!1,I={UNSELECTED:0,SELECTED:1,DRAGGING:2,ROTATING:3,ROTATING_FREE:4,PANNING:5},J=I.UNSELECTED;this.needsUpdate=!0,this.isRotating=function(){return J==I.ROTATING||J==I.ROTATING_FREE},this.selectedObject=function(){return D},this.itemIntersection=function(a,b){var c=b.customIntersectionPlanes(),d=null;return d=c&&c.length>0?this.getIntersections(a,c,!0):this.getIntersections(a,z),d.length>0?d[0]:null},this.getIntersections=function(b,c,e,f,g,h){var i=w(b);f=f||!1,e=e||!1,g=g||!1,h=h||20;var j=i.sub(d.position).normalize(),k=new THREE.Raycaster(d.position,j);k.linePrecision=h;var l;return l=c instanceof Array?k.intersectObjects(c,g):k.intersectObject(c,g),f&&(l=a.Core.Utils.removeIf(l,function(a){return!a.object.visible})),e&&(l=a.Core.Utils.removeIf(l,function(a){var b=a.face.normal.dot(j);return b>0})),l},this.setSelectedObject=function(a){J===I.UNSELECTED&&r(I.SELECTED),null!=D&&D.setUnselected(),null!=a?(D=a,D.setSelected(),b.itemSelectedCallbacks.fire(a)):(D=null,b.itemUnselectedCallbacks.fire()),this.needsUpdate=!0},h()}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.Floor=function(a,b){function c(){f.room.fireOnFloorChange(d),g=e()}function d(){f.removeFromScene(),g=e(),f.addToScene()}function e(){var a=f.room.getTexture(),b=THREE.ImageUtils.loadTexture(a.url);b.wrapS=THREE.RepeatWrapping,b.wrapT=THREE.RepeatWrapping,b.repeat.set(1,1);var c=new THREE.MeshPhongMaterial({map:b,side:THREE.DoubleSide,color:13421772,specular:657930}),d=a.scale,e=[];f.room.interiorCorners.forEach(function(a){e.push(new THREE.Vector2(a.x/d,a.y/d))});var g=new THREE.Shape(e),h=new THREE.ShapeGeometry(g),i=new THREE.Mesh(h,c);return i.rotation.set(Math.PI/2,0,0),i.scale.set(d,d,d),i.receiveShadow=!0,i.castShadow=!1,i}var f=this;this.room=b;var a=a,g=null;c(),this.addToScene=function(){a.add(g),a.add(b.floorPlane)},this.removeFromScene=function(){a.remove(g),a.remove(b.floorPlane)}}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(b){b.Edge=function(b,c,d){function e(){c.redrawCallbacks.add(f),d.cameraMovedCallbacks.add(i),k(),l(),h()}function f(){g(),k(),l(),h()}function g(){u.forEach(function(a){b.remove(a)}),v.forEach(function(a){b.remove(a)}),u=[],v=[]}function h(){u.forEach(function(a){b.add(a)}),v.forEach(function(a){b.add(a)}),i()}function i(){var a=c.interiorStart(),b=c.interiorEnd(),e=b.x-a.x,f=b.y-a.y,g=new THREE.Vector3((-f),0,e);g.normalize();var h=d.object.position.clone(),i=new THREE.Vector3((a.x+b.x)/2,0,(a.y+b.y)/2),k=h.sub(i).normalize(),l=g.dot(k);r.visible=l>=0,u.forEach(function(a){a.visible=r.visible}),j()}function j(){s.items.forEach(function(a){a.updateEdgeVisibility(r.visible,t)}),s.onItems.forEach(function(a){a.updateEdgeVisibility(r.visible,t)})}function k(a){a=a||function(){b.needsUpdate=!0};var d=c.getTexture(),e=d.stretch,f=d.url,g=d.scale;if(w=THREE.ImageUtils.loadTexture(f,null,a),!e){var h=s.height,i=c.interiorDistance();w.wrapT=THREE.RepeatWrapping,w.wrapS=THREE.RepeatWrapping,w.repeat.set(i/g,h/g),w.needsUpdate=!0}}function l(){var a=new THREE.MeshBasicMaterial({color:16777215,side:THREE.FrontSide,map:w}),b=new THREE.MeshBasicMaterial({color:x,side:THREE.DoubleSide});u.push(m(c.exteriorStart(),c.exteriorEnd(),c.exteriorTransform,c.invExteriorTransform,b)),u.push(m(c.interiorStart(),c.interiorEnd(),c.interiorTransform,c.invInteriorTransform,a)),v.push(o(c,0,THREE.BackSide,z)),u.push(o(c,s.height,THREE.DoubleSide,x)),u.push(n(c.interiorStart(),c.exteriorStart(),s.height,y)),u.push(n(c.interiorEnd(),c.exteriorEnd(),s.height,y))}function m(b,c,d,e,f){function g(b){var c=a.Core.Utils.distance(h.x,h.z,b.x,b.z)/o,d=b.y/p;return new THREE.Vector2(c,d)}var h=q(b),i=q(c),j=i.clone();j.y=s.height;var k=h.clone();k.y=s.height;var l=[h.clone(),i.clone(),j.clone(),k.clone()];l.forEach(function(a){a.applyMatrix4(d)});var m=new THREE.Shape([new THREE.Vector2(l[0].x,l[0].y),new THREE.Vector2(l[1].x,l[1].y),new THREE.Vector2(l[2].x,l[2].y),new THREE.Vector2(l[3].x,l[3].y)]);s.items.forEach(function(a){var b=a.position.clone();b.applyMatrix4(d);var c=a.halfSize,e=c.clone().multiplyScalar(-1),f=c.clone();e.add(b),f.add(b);var g=[new THREE.Vector2(e.x,e.y),new THREE.Vector2(f.x,e.y),new THREE.Vector2(f.x,f.y),new THREE.Vector2(e.x,f.y)];m.holes.push(new THREE.Path(g))});var n=new THREE.ShapeGeometry(m);n.vertices.forEach(function(a){a.applyMatrix4(e)});var o=a.Core.Utils.distance(h.x,h.z,i.x,i.z),p=s.height;n.faceVertexUvs[0]=[],n.faces.forEach(function(a){var b=n.vertices[a.a],c=n.vertices[a.b],d=n.vertices[a.c];n.faceVertexUvs[0].push([g(b),g(c),g(d)])}),n.faceVertexUvs[1]=n.faceVertexUvs[0],n.computeFaceNormals(),n.computeVertexNormals();var r=new THREE.Mesh(n,f);return r}function n(a,b,c,d){var e=[q(a),q(b),q(b,c),q(a,c)],f=new THREE.Geometry;e.forEach(function(a){f.vertices.push(a)}),f.faces.push(new THREE.Face3(0,1,2)),f.faces.push(new THREE.Face3(0,2,3));var g=new THREE.MeshBasicMaterial({color:d,side:THREE.DoubleSide}),h=new THREE.Mesh(f,g);return h}function o(a,b,c,d){var e=[p(a.exteriorStart()),p(a.exteriorEnd()),p(a.interiorEnd()),p(a.interiorStart())],f=new THREE.MeshBasicMaterial({color:d,side:c}),g=new THREE.Shape(e),h=new THREE.ShapeGeometry(g),i=new THREE.Mesh(h,f);return i.rotation.set(Math.PI/2,0,0),i.position.y=b,i}function p(a){return new THREE.Vector2(a.x,a.y)}function q(a,b){return b=b||0,new THREE.Vector3(a.x,b,a.y)}var r=this,b=b,c=c,d=d,s=c.wall,t=c.front,u=[],v=[],w=null,x=(THREE.ImageUtils.loadTexture("rooms/textures/walllightmap.png"),14540253),y=13421772,z=14540253;this.visible=!1,this.remove=function(){c.redrawCallbacks.remove(f),d.cameraMovedCallbacks.remove(i),g()},e()}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.Floorplan=function(b,c,d){function e(){f.floors.forEach(function(a){a.removeFromScene()}),f.edges.forEach(function(a){a.remove()}),f.floors=[],f.edges=[],f.floorplan.getRooms().forEach(function(c){var d=new a.Floor(b,c);f.floors.push(d),d.addToScene()}),f.floorplan.wallEdges().forEach(function(c){var d=new a.Edge(b,c,f.controls);f.edges.push(d)})}var f=this;this.scene=b,this.floorplan=c,this.controls=d,this.floors=[],this.edges=[],c.fireOnUpdatedRooms(e)}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.Lights=function(a,b){function c(){var c=new THREE.HemisphereLight(16777215,8947848,1.1);c.position.set(0,g,0),a.add(c),e=new THREE.DirectionalLight(16777215,0),e.color.setHSL(1,1,.1),e.castShadow=!0,e.shadowMapWidth=1024,e.shadowMapHeight=1024,e.shadowCameraFar=g+f,e.shadowBias=-1e-4,e.shadowDarkness=.2,e.visible=!0,e.shadowCameraVisible=!1,a.add(e),a.add(e.target),b.fireOnUpdatedRooms(d)}function d(){var a=b.getSize(),c=(Math.max(a.z,a.x)+f)/2,d=b.getCenter(),h=new THREE.Vector3(d.x,g,d.z);e.position.copy(h),e.target.position.copy(d),e.shadowCameraLeft=-c,e.shadowCameraRight=c,e.shadowCameraTop=c,e.shadowCameraBottom=-c,e.shadowCamera&&(e.shadowCamera.left=e.shadowCameraLeft,e.shadowCamera.right=e.shadowCameraRight,e.shadowCamera.top=e.shadowCameraTop,e.shadowCamera.bottom=e.shadowCameraBottom,e.shadowCamera.updateProjectionMatrix())}var e,a=a,b=b,f=1,g=300;this.getDirLight=function(){return e},c()}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.Skybox=function(a){function b(){var b={topColor:{type:"c",value:new THREE.Color(c)},bottomColor:{type:"c",value:new THREE.Color(d)},offset:{type:"f",value:e}},k=new THREE.SphereGeometry(f,g,h),l=new THREE.ShaderMaterial({vertexShader:i,fragmentShader:j,uniforms:b,side:THREE.BackSide}),m=new THREE.Mesh(k,l);a.add(m)}var a=a,c=16777215,d=15329769,e=500,f=4e3,g=32,h=15,i=["varying vec3 vWorldPosition;","void main() {","  vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","  vWorldPosition = worldPosition.xyz;","  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),j=["uniform vec3 topColor;","uniform vec3 bottomColor;","uniform float offset;","varying vec3 vWorldPosition;","void main() {","  float h = normalize( vWorldPosition + offset ).y;","  gl_FragColor = vec4( mix( bottomColor, topColor, (h + 1.0) / 2.0), 1.0 );","}"].join("\n");b()}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.Controls=function(a,b){function c(){return 2*Math.PI/60/60*m.autoRotateSpeed}function d(){return Math.pow(.95,m.zoomSpeed)}function e(a){if(m.enabled!==!1){if(a.preventDefault(),0===a.button){if(m.noRotate===!0)return;C=B.ROTATE,o.set(a.clientX,a.clientY)}else if(1===a.button){if(m.noZoom===!0)return;C=B.DOLLY,u.set(a.clientX,a.clientY)}else if(2===a.button){if(m.noPan===!0)return;C=B.PAN,r.set(a.clientX,a.clientY)}m.domElement.addEventListener("mousemove",f,!1),m.domElement.addEventListener("mouseup",g,!1)}}function f(a){if(m.enabled!==!1){a.preventDefault();var b=m.domElement===document?m.domElement.body:m.domElement;if(C===B.ROTATE){if(m.noRotate===!0)return;p.set(a.clientX,a.clientY),q.subVectors(p,o),m.rotateLeft(2*Math.PI*q.x/b.clientWidth*m.rotateSpeed),m.rotateUp(2*Math.PI*q.y/b.clientHeight*m.rotateSpeed),o.copy(p)}else if(C===B.DOLLY){if(m.noZoom===!0)return;v.set(a.clientX,a.clientY),w.subVectors(v,u),w.y>0?m.dollyIn():m.dollyOut(),u.copy(v)}else if(C===B.PAN){if(m.noPan===!0)return;s.set(a.clientX,a.clientY),t.subVectors(s,r),m.pan(t),r.copy(s)}m.update()}}function g(){m.enabled!==!1&&(m.domElement.removeEventListener("mousemove",f,!1),m.domElement.removeEventListener("mouseup",g,!1),C=B.NONE)}function h(a){if(m.enabled!==!1&&m.noZoom!==!0){var b=0;a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail),b>0?m.dollyOut():m.dollyIn(),m.update()}}function i(a){if(m.enabled!==!1&&m.noKeys!==!0&&m.noPan!==!0)switch(a.keyCode){case m.keys.UP:m.pan(new THREE.Vector2(0,m.keyPanSpeed));break;case m.keys.BOTTOM:m.pan(new THREE.Vector2(0,(-m.keyPanSpeed)));break;case m.keys.LEFT:m.pan(new THREE.Vector2(m.keyPanSpeed,0));break;case m.keys.RIGHT:m.pan(new THREE.Vector2((-m.keyPanSpeed),0))}}function j(a){if(m.enabled!==!1)switch(a.touches.length){case 1:if(m.noRotate===!0)return;C=B.TOUCH_ROTATE,o.set(a.touches[0].pageX,a.touches[0].pageY);break;case 2:if(m.noZoom===!0)return;C=B.TOUCH_DOLLY;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY,d=Math.sqrt(b*b+c*c);u.set(0,d);break;case 3:if(m.noPan===!0)return;C=B.TOUCH_PAN,r.set(a.touches[0].pageX,a.touches[0].pageY);break;default:C=B.NONE}}function k(a){if(m.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=m.domElement===document?m.domElement.body:m.domElement;switch(a.touches.length){case 1:if(m.noRotate===!0)return;if(C!==B.TOUCH_ROTATE)return;p.set(a.touches[0].pageX,a.touches[0].pageY),q.subVectors(p,o),m.rotateLeft(2*Math.PI*q.x/b.clientWidth*m.rotateSpeed),m.rotateUp(2*Math.PI*q.y/b.clientHeight*m.rotateSpeed),o.copy(p);break;case 2:if(m.noZoom===!0)return;if(C!==B.TOUCH_DOLLY)return;var c=a.touches[0].pageX-a.touches[1].pageX,d=a.touches[0].pageY-a.touches[1].pageY,e=Math.sqrt(c*c+d*d);v.set(0,e),w.subVectors(v,u),w.y>0?m.dollyOut():m.dollyIn(),u.copy(v);break;case 3:if(m.noPan===!0)return;if(C!==B.TOUCH_PAN)return;s.set(a.touches[0].pageX,a.touches[0].pageY),t.subVectors(s,r),m.pan(t),r.copy(s);break;default:C=B.NONE}}}function l(){m.enabled!==!1&&(C=B.NONE)}this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1500,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=40,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI/2,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.cameraMovedCallbacks=$.Callbacks(),this.needsUpdate=!0;var m=this,n=1e-6,o=new THREE.Vector2,p=new THREE.Vector2,q=new THREE.Vector2,r=new THREE.Vector2,s=new THREE.Vector2,t=new THREE.Vector2,u=new THREE.Vector2,v=new THREE.Vector2,w=new THREE.Vector2,x=0,y=0,z=1,A=new THREE.Vector3,B={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},C=B.NONE;this.controlsActive=function(){return C===B.NONE},this.setPan=function(a){A=a},this.panTo=function(a){var b=new THREE.Vector3(a.x,m.target.y,a.z),c=m.target.clone().sub(b);A.sub(c),m.update()},this.rotateLeft=function(a){void 0===a&&(a=c()),y-=a},this.rotateUp=function(a){void 0===a&&(a=c()),x-=a},this.panLeft=function(a){var b=new THREE.Vector3,c=this.object.matrix.elements;b.set(c[0],0,c[2]),b.normalize(),b.multiplyScalar(-a),A.add(b)},this.panUp=function(a){var b=new THREE.Vector3,c=this.object.matrix.elements;b.set(c[4],0,c[6]),b.normalize(),b.multiplyScalar(a),A.add(b)},this.pan=function(a){var b=m.domElement===document?m.domElement.body:m.domElement;if(void 0!==m.object.fov){var c=m.object.position,d=c.clone().sub(m.target),e=d.length();e*=Math.tan(m.object.fov/2*Math.PI/180),m.panLeft(2*a.x*e/b.clientHeight),m.panUp(2*a.y*e/b.clientHeight)}else void 0!==m.object.top?(m.panLeft(a.x*(m.object.right-m.object.left)/b.clientWidth),m.panUp(a.y*(m.object.top-m.object.bottom)/b.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.");m.update()},this.panXY=function(a,b){m.pan(new THREE.Vector2(a,b))},this.dollyIn=function(a){void 0===a&&(a=d()),z/=a},this.dollyOut=function(a){void 0===a&&(a=d()),z*=a},this.update=function(){var a=this.object.position,b=a.clone().sub(this.target),d=Math.atan2(b.x,b.z),e=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y);this.autoRotate&&this.rotateLeft(c()),d+=y,e+=x,e=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,e)),e=Math.max(n,Math.min(Math.PI-n,e));var f=b.length()*z;f=Math.max(this.minDistance,Math.min(this.maxDistance,f)),this.target.add(A),b.x=f*Math.sin(e)*Math.sin(d),b.y=f*Math.cos(e),b.z=f*Math.sin(e)*Math.cos(d),a.copy(this.target).add(b),this.object.lookAt(this.target),y=0,x=0,z=1,A.set(0,0,0),this.cameraMovedCallbacks.fire(),this.needsUpdate=!0},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousewheel",h,!1),this.domElement.addEventListener("DOMMouseScroll",h,!1),this.domElement.addEventListener("touchstart",j,!1),this.domElement.addEventListener("touchend",l,!1),this.domElement.addEventListener("touchmove",k,!1),window.addEventListener("keydown",i,!1)}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.HUD=function(a){function b(){a.itemSelectedCallbacks.add(d),a.itemUnselectedCallbacks.add(e)}function c(){p=null,w&&(o.remove(w),w=null)}function d(a){p!=a&&(c(),a.allowRotate&&!a.fixed&&(p=a,w=m(p),o.add(w)))}function e(){c()}function f(){w&&w.children.forEach(function(a){a.material.color.set(g())}),a.needsUpdate()}function g(){return r||q?v:u}function h(a){var b=new THREE.Geometry;return b.vertices.push(new THREE.Vector3(0,0,0),i(a)),b}function i(a){var b=new THREE.Vector3(0,0,Math.max(a.halfSize.x,a.halfSize.z)+1.4+t);return b}function j(a){var b=new THREE.LineBasicMaterial({color:g(),linewidth:3});return b}function k(a){var b=new THREE.CylinderGeometry(5,0,10),c=new THREE.MeshBasicMaterial({color:g()}),d=new THREE.Mesh(b,c);return d.position.copy(i(a)),d.rotation.x=-Math.PI/2,d}function l(a){var b=new THREE.SphereGeometry(4,16,16),c=new THREE.MeshBasicMaterial({color:g()}),d=new THREE.Mesh(b,c);return d}function m(a){var b=new THREE.Object3D,c=new THREE.Line(h(a),j(n.rotating),THREE.LinePieces),d=k(a),e=l(a);return b.add(c),b.add(d),b.add(e),b.rotation.y=a.rotation.y,b.position.x=a.position.x,b.position.z=a.position.z,b.position.y=s,b}var n=this,a=a,o=new THREE.Scene,p=null,q=!1,r=!1,s=5,t=20,u="#ffffff",v="#f1c40f",w=null;this.getScene=function(){return o},this.getObject=function(){return w},this.setRotating=function(a){
q=a,f()},this.setMouseover=function(a){r=a,f()},this.update=function(){w&&(w.rotation.y=p.rotation.y,w.position.x=p.position.x,w.position.z=p.position.z)},b()}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){a.Main=function(b,c,d,e){function f(){THREE.ImageUtils.crossOrigin="",o=k.element.get(0),p=new THREE.PerspectiveCamera(45,1,1,1e4),q=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}),q.autoClear=!1,q.shadowMapEnabled=!0,q.shadowMapSoft=!0,q.shadowMapType=THREE.PCFSoftShadowMap;new a.Skybox(n);k.controls=new a.Controls(p,o),t=new a.HUD(k),r=new a.Controller(k,b,p,k.element,k.controls,t),o.appendChild(q.domElement),k.updateWindowSize(),l.resize&&$(window).resize(k.updateWindowSize),k.centerCamera(),b.floorplan.fireOnUpdatedRooms(k.centerCamera);new a.Lights(n,b.floorplan);s=new a.Floorplan(n,b.floorplan,k.controls),j(),k.element.mouseenter(function(){w=!0}).mouseleave(function(){w=!1}).click(function(){x=!0})}function g(){if(l.spin&&!w&&!x){var a=2*Math.PI*l.spinSpeed*(Date.now()-v);k.controls.rotateLeft(a),k.controls.update()}}function h(){return!!(k.controls.needsUpdate||r.needsUpdate||u||b.scene.needsUpdate)&&(k.controls.needsUpdate=!1,r.needsUpdate=!1,u=!1,b.scene.needsUpdate=!1,!0)}function i(){g(),h()&&(q.clear(),q.render(n.getScene(),p),q.clearDepth(),q.render(t.getScene(),p)),v=Date.now()}function j(){var a=50;setTimeout(function(){requestAnimationFrame(j)},a),i()}var k=this,l={resize:!0,pushHref:!1,spin:!0,spinSpeed:2e-5,clickPan:!0,canMoveFixedItems:!1};for(var m in l)l.hasOwnProperty(m)&&e.hasOwnProperty(m)&&(l[m]=e[m]);var n=b.scene,b=b;this.element=$(c);var o,p,q;this.controls;var r,s,t,u=!1,v=Date.now(),w=!1,x=!1;this.heightMargin,this.widthMargin,this.elementHeight,this.elementWidth,this.itemSelectedCallbacks=$.Callbacks(),this.itemUnselectedCallbacks=$.Callbacks(),this.wallClicked=$.Callbacks(),this.floorClicked=$.Callbacks(),this.nothingClicked=$.Callbacks(),this.dataUrl=function(){var a=q.domElement.toDataURL("image/png");return a},this.stopSpin=function(){x=!0},this.options=function(){return l},this.getModel=function(){return b},this.getScene=function(){return n},this.getController=function(){return r},this.getCamera=function(){return p},this.needsUpdate=function(){u=!0},this.rotatePressed=function(){r.rotatePressed()},this.rotateReleased=function(){r.rotateReleased()},this.setCursorStyle=function(a){o.style.cursor=a},this.updateWindowSize=function(){k.heightMargin=k.element.offset().top,k.widthMargin=k.element.offset().left,k.elementWidth=k.element.innerWidth(),l.resize?k.elementHeight=window.innerHeight-k.heightMargin:k.elementHeight=k.element.innerHeight(),p.aspect=k.elementWidth/k.elementHeight,p.updateProjectionMatrix(),q.setSize(k.elementWidth,k.elementHeight),u=!0},this.centerCamera=function(){var a=150,c=b.floorplan.getCenter();c.y=a,k.controls.target=c;var d=1.5*b.floorplan.getSize().z,e=c.clone().add(new THREE.Vector3(0,d,d));p.position.copy(e),k.controls.update()},this.projectVector=function(a,b){b=b||!1;var c=k.elementWidth/2,d=k.elementHeight/2,e=new THREE.Vector3;e.copy(a),e.project(p);var f=new THREE.Vector2;return f.x=e.x*c+c,f.y=-(e.y*d)+d,b||(f.x+=k.widthMargin,f.y+=k.heightMargin),f},f()}}(b=a.Three||(a.Three={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b=function(){function b(b){this.model=new a.Model.Model(b.textureDir),this.three=new a.Three.Main(this.model,b.threeElement,b.threeCanvasElement,{}),b.widget?this.three.getController().enabled=!1:this.floorplanner=new a.Floorplanner.Floorplanner(b.floorplannerElement,this.model.floorplan)}return b}();a.Blueprint3d=b}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){function b(b,c){return a.logContext===d.All||a.logContext==b||c===e.Warning||c===e.Error||c===e.Fatal}function c(a,c,d){if(b(a,c)!==!1){var f="";switch(c){case e.Information:f="[INFO_] ";break;case e.Warning:f="[WARNG] ";break;case e.Error:f="[ERROR] ";break;case e.Fatal:f="[FATAL] ";break;case e.Debug:f="[DEBUG] "}console.log(f+d)}}!function(a){a[a.None=0]="None",a[a.All=1]="All",a[a.Interaction2d=2]="Interaction2d",a[a.Item=3]="Item",a[a.Wall=4]="Wall",a[a.Room=5]="Room"}(a.ELogContext||(a.ELogContext={}));var d=a.ELogContext;!function(a){a[a.Information=0]="Information",a[a.Warning=1]="Warning",a[a.Error=2]="Error",a[a.Fatal=3]="Fatal",a[a.Debug=4]="Debug"}(a.ELogLevel||(a.ELogLevel={}));var e=a.ELogLevel;a.logContext=d.None,a.isLogging=b,a.log=c}(b=a.Core||(a.Core={}))}(BP3D||(BP3D={}));var BP3D;!function(a){var b;!function(a){var b=function(){function a(){}return a.getInformalVersion=function(){return"1.0 Beta 1"},a.getTechnicalVersion=function(){return"1.0.0.1"},a}();a.Version=b}(b=a.Core||(a.Core={}))}(BP3D||(BP3D={})),console.log("Blueprint3D "+BP3D.Core.Version.getInformalVersion()+" ("+BP3D.Core.Version.getTechnicalVersion()+")");
//# sourceMappingURL=blueprint3d.min.js.map